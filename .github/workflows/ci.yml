name: 🚀 Continuous Integration 🛠️
run-name: "🚀 Continuous Integration | Install | Build | Tests | Commit: ${{ github.sha }} 🛠️"
on:
  push:
    branches:
      - ext-dev
      # - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt-get update

          # "Installing wget, build-essential, cmake, git"
          sudo apt-get install -y wget build-essential cmake git

          # Install JUCE dependencies
          sudo apt-get install -y \
          libasound2-dev libjack-jackd2-dev \
          ladspa-sdk \
          libcurl4-openssl-dev \
          libfreetype-dev libfontconfig1-dev \
          libx11-dev libxcomposite-dev libxcursor-dev libxext-dev libxinerama-dev libxrandr-dev libxrender-dev \
          libwebkit2gtk-4.1-dev \
          libglu1-mesa-dev mesa-common-dev
          
          # Install BTrack dependencies
          sudo apt-get install -y libsamplerate0 libsamplerate-dev

          # Install submodules
          git submodule init
          git submodule update
      
      - name: Build project
        run: |
          cmake -S . -DBUILD_PLUGIN_HOST=OFF -B build 
          cmake --build build
      
      # Cache the build output using GitHub Actions cache
      - name: Cache build output
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-build-${{ github.sha }}

  test-auto-tempo-detection:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Restore the build cache
      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-build-${{ github.sha }}
          fail-on-cache-miss: true
      
      # Install runtime dependencies only
      - name: Install runtime dependencies
        run: |
          sudo apt update
          sudo apt-get install -y libsamplerate0
      
      - name: Apply Auto-Tempo-Detection tests
        run: ${PWD}/build/test/AutoTempoDetectionTests

  test-btrack:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Restore the build cache
      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-build-${{ github.sha }}
          fail-on-cache-miss: true
      
      # Install runtime dependencies only
      - name: Install runtime dependencies
        run: |
          sudo apt update
          sudo apt-get install -y libsamplerate0
      
      - name: Apply BTrack tests
        run: ${PWD}/build/libs/BTrack/tests/Tests